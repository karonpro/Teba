{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="card p-3">
    <h3>Customer Details</h3>

    <!-- Customer Info -->
    <div class="mb-3">
        <strong>Name:</strong> {{ customer.name }} <br>
        <strong>Phone:</strong> {{ customer.phone|default:"-" }} <br>
        <strong>Email:</strong> {{ customer.email|default:"-" }} <br>
        <strong>TIN:</strong> {{ customer.tin|default:"-" }} <br>
        <strong>Supply:</strong> {{ total_supply|floatformat:2 }} <br>
        <strong>Total Paid:</strong> {{ total_paid|floatformat:2 }} <br>
        <strong>Balance:</strong> 
            <span style="color: {{ customer.balance_color }}; font-weight: bold;">
                {{ customer.balance|floatformat:2 }}
            </span> <br>
        <strong>Last Payment:</strong>
            {% if last_payment %}
                {{ last_payment.amount|floatformat:2 }} ({{ last_payment.date|date:"Y-m-d" }})
            {% else %}
                -
            {% endif %}
    </div>

    <!-- Supply History Table -->
    <h5>Supply History</h5>
    <table class="table table-striped table-dark">
        <thead>
            <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Added By</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for supply in supply_history %}
            <tr>
                <td>{{ supply.date|date:"Y-m-d H:i" }}</td>
                <td>{{ supply.amount|floatformat:2 }}</td>
                <td>{{ supply.added_by.username|default:"-" }}</td>
                <td>{{ supply.notes|default:"-" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4">No supply history.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Payments Table -->
    <h5>Payments</h5>
    <table class="table table-striped table-dark">
        <thead>
            <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in customer.payments.all %}
            <tr>
                <td>{{ payment.date|date:"Y-m-d" }}</td>
                <td>{{ payment.amount|floatformat:2 }}</td>
                <td>{{ payment.method }}</td>
                <td>{{ payment.notes|default:"-" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4">No payments found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Transactions Table -->
    {% if transactions %}
    <h5>Transactions</h5>
    <table class="table table-dark table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Notes</th>
                <th>Paid</th>
                <th>Debt</th>
                <th>Cash</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for t in transactions %}
            <tr>
                <td>{{ t.date|date:"Y-m-d" }}</td>
                <td>{{ t.notes|default:"-" }}</td>
                <td>{{ t.paid|floatformat:2 }}</td>
                <td>{{ t.debt|floatformat:2 }}</td>
                <td>{{ t.cash|floatformat:2 }}</td>
                <td>
                    <a href="{% url 'transactions:edit' t.id %}" class="btn btn-primary btn-sm">Edit</a>
                    <a href="{% url 'transactions:delete' t.id %}" class="btn btn-danger btn-sm">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <!-- Back / Add Supply Buttons -->
    <div class="mt-3">
        <a href="{% url 'transactions:customers' %}" class="btn btn-light">Back to Customers</a>
        <a href="{% url 'transactions:add_supply' customer.id %}" class="btn btn-warning">Add Supply</a>
    </div>
</div>
{% endblock %}
